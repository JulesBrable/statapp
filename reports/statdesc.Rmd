---
title: "sampling"
author: "Jules Brable"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, error = F, warning = F, message = F) 
```

### SETTING ENVIRONEMENT

```{r}
library(tidyverse)

source(here::here("R/functions/statdesc_functions.R"))
source(here::here("R/functions/sampling_functions.R"))

df <- load_data("data.csv")

pma <- c("Infertility Treatment Used",
         "Fertility Enhancing Drugs",
         "Asst. Reproductive Technology")
```

# STAT DESC

<br>

Sur les `r df %>% nrow()` données de notre échantillon (2018 + 2019 + 2020 + 2021), on a:

<br>

```{r echo=FALSE}
df %>% 
  get_prop(rf_inftr) %>% 
  bind_rows(df %>% 
              get_prop(rf_fedrg)) %>% 
  bind_rows(df %>% 
              get_prop(rf_artec)) %>% 
  mutate(var = pma) %>%
  relocate(var) %>% 
  kableExtra::kbl() %>% 
  template()
```

<br>

```{r}
df %>%
  transform_age() %>% 
  pyrage()
  
df %>%
  get_prop(rf_artec) %>%
  kableExtra::kbl() %>% 
  template()

df %>%
  get_prop(rf_inftr) %>%
  kableExtra::kbl() %>% 
  template()
```

<br>

```{r}
df <- df %>% 
  filter(meduc != 9, fagerec11 != 11, frace6 != 9, feduc != 9, apgar5 != 5, priorlive != 99)

df %>% dim()
```

<br>

### Population cible

```{r}
pop <- df %>% filter(rf_fedrg == "Y")
pop %>% dim()

popnc <- df %>% filter(rf_fedrg != "Y")
```

<br>

Parmi ceux qui ont eu recours à des traitements contre l'infertilité (ie, la population cible), voici la répartition du recours ou non à des traitements contre l'infertilité sous forme de médicaments ou insémination artificielle :

<br>

```{r}
pop %>% get_prop(rf_fedrg) %>%
  kableExtra::kbl() %>% 
  template()
```

<br>
 
Et sous forme d'assisted reproductive technology (ART) (IVF ou autres):

<br>

```{r}
pop %>% get_prop(rf_artec) %>%
  kableExtra::kbl() %>% 
  template()
```

<br>
 
Et sous forme d'assisted reproductive technology (ART) (IVF ou autres):

<br>

**Répartition de la population cible selon le nombre d'enfants avant cette naissance:**

<br>

```{r}
pop %>% get_prop(priorlive) %>%
  kableExtra::kbl() %>% 
  template()
```

```{r}
popnc %>%
  get_prop(priorlive) %>%
  kableExtra::kbl() %>% 
  template()
```

### Age des parents

<br>

```{r}
pop %>%
  transform_age() %>% 
  pyrage()
```

```{r}
pop %>%
  get_prop(fagerec11) %>%
  kableExtra::kbl() %>% 
  template()
```

<br>

```{r}
popnc %>%
  get_prop(fagerec11) %>%
  kableExtra::kbl() %>% 
  template()
```

<br>

```{r}
pop %>% 
  transform_age() %>%
  summary("age")

popnc %>% 
  transform_age() %>%
  summary("age")
```

<br>

Sur la population cible, l'âge médian des hommes est de `r pop %>% transform_age() %>% filter(sex == "M") %>% summarize(res = median(age)) %>% pull(res)` ans, contre `r pop %>% transform_age() %>% filter(sex == "F") %>% summarize(res = median(age)) %>% pull(res)` ans pour les femmes.

Sur les non traités, l'âge médian des hommes est de `r popnc %>% transform_age() %>% filter(sex == "M") %>% summarize(res = median(age)) %>% pull(res)` ans, contre `r popnc %>% transform_age() %>% filter(sex == "F") %>% summarize(res = median(age)) %>% pull(res)` ans pour les femmes.

### Ethnie des parents

<br>

```{r}
summary(pop %>% mutate(mrace6 = mrace6/10) %>% select(mrace6)) %>% 
  bind_cols(summary(select(pop,frace6)))

round(table(pop$frace6)/length(pop$frace6),3)
round(table(pop$mrace15)/length(pop$mrace6),3)
# taux similaires pour les mères
```


```{r}
hist(pop$frace6, col = "cornflowerblue", xlab = "", main  = "ethnie du père (pop cible")

hist(popnc$frace6, col = "cornflowerblue", xlab = "", main  = "ethnie du père (pop NT")

```

<br>

### Education des parents

<br>

Sur la population cible, on a :

<br>

```{r}
summary(select(pop,meduc))
summary(select(pop,feduc))
```

<br>

```{r}
round(table(pop$meduc)/length(pop$meduc),3)
round(table(pop$feduc)/length(pop$feduc),3)
```


Alors que sur la population entière on obtient :

```{r}
summary(select(popnc,meduc))
summary(select(popnc,feduc))
```

<br>

```{r}
round(table(popnc$meduc)/length(popnc$meduc),3)
round(table(popnc$feduc)/length(popnc$feduc),3)
```

<br>

```{r}
hist(pop$feduc, col = "cornflowerblue", xlab = "", main  = "niveau d'éducation du père (pop cible)")
hist(pop$meduc, col = "cornflowerblue", xlab = "", main  = "niveau d'éducation de la mère (pop cible)")
```

<br>

### Caractéristiques du couple

<br>

```{r}
summary(select(pop,dmar))
summary(select(pop,priorlive))
summary(select(pop,dplural))
round(table(pop$dmar)/length(pop$dmar),3)
round(table(pop$priorlive)/length(pop$priorlive),3)
round(table(pop$dplural)/length(pop$dplural),3)
```

```{r}
hist(pop$priorlive, col = "cornflowerblue", xlab = "", main  = "nombre d'enfants")
box()
```
`
<br>

Sur la population entière: 

<br>

```{r}
summary(select(popnc,dmar))
summary(select(popnc,priorlive))
summary(select(popnc,dplural))
round(table(popnc$dmar)/length(popnc$dmar),3)
round(table(popnc$priorlive)/length(popnc$priorlive),3)
round(table(popnc$dplural)/length(popnc$dplural),3)
```

<br>

### Santé de l'enfant

<br>

```{r}
summary(select(pop,apgar5r))
summary(select(pop,dbwt))
```

```{r}
hist(pop$apgar5r, col = "cornflowerblue", xlab = "", main  = "Score Apgar")
```


```{r}
plot(density(pop$dbwt), lwd = 2, col = "orange", xlab = "", main = "poids à la naissance")
```

Sur la population entière :

```{r}
summary(select(popnc,apgar5r))
summary(select(popnc,dbwt))
```

```{r}
hist(popnc$apgar5r, col = "cornflowerblue", xlab = "", main  = "Score Apgar")
```
```{r}
plot(density(popnc$dbwt), lwd = 2, col = "orange", xlab = "", main = "poids à la naissance")
```

<br>

## Régressions linéaires

<br>

```{r}
to_keep <- c("dbwt", "mager", "meduc", "mrace6", "fagerec11", "feduc", "frace6", "priorlive", "dmar", "rf_artec")
df_reg <- df %>% select(to_keep)
```

<br>

Régression du poids à la naissance sur plusieurs variables explicatives (dont l'age de la mere au carré):

<br>

```{r}
df_reg$age2 <- df_reg$mager**2

res <- lm(dbwt ~ .,
       data = df_reg)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(res, type = "html")
```
</div>

<br>

En ajoutant l'année :

<br>

```{r}
df_reg <- df %>% select(to_keep, dob_yy)
df_reg$age2 <- df_reg$mager**2

res <- lm(dbwt ~ .,
       data = df_reg)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(res, type = "html")
```
</div>

<br>

En ajoutant la gémélité:

<br>

```{r}
df_reg <- df %>% select(to_keep, dplural)
MR3 <- lm(dbwt ~ .,
          data = df_reg)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(MR3, type = "html")
```
</div>

<br>

Avec la gémélité, l'année et l'age de la mere au carré:

<br>

```{r}
df_reg <- df %>% select(to_keep, dplural, dob_yy)

MR4 <- lm(dbwt ~ .,
          data = df_reg)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(MR4, type = "html")
```
</div>

<br>
### Corélation entre le recours à médicaments et la gémélité

```{r}
gemelite <- lm(dplural ~ mager + rf_fedrg + rf_artec, data=df)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(gemelite, type = "html")
```
</div>

<br>

Reste à faire des tests d'indépendance (Khi2/KS/Student)