---
title: "Report"
author: "Jules Brable"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, error = F, warning = F, message = F) 
```

### DATA IMPORTATION

```{r}
library(tidyverse)

source(here::here("R/functions/statdesc_functions.R"))
source(here::here("R/functions/sampling_functions.R"))

df <- load_data("data.csv")

pma <- c("Infertility Treatment Used",
         "Fertility Enhancing Drugs",
         "Asst. Reproductive Technology")
```

<br>

Remarque préalable : "Infertility Treatment Used" (évènement A) est la réunion (au sens probabiliste) de "Fertility Enhancing Drugs" (évènement B1) et "Asst. Reproductive Technology" (évènement B2). En effet, P(A) = P(B1) + P(B2) - P(B1,B2) et P(A|B1<sup>c</sup>, B2<sup>c</sup>) = 0 :

<br>

```{r}
df2021 <- load_data("nat2021us.csv")

df2021 %>% 
  filter(rf_inftr == "Y") %>% 
  nrow()

df2021 %>% 
  filter(rf_fedrg == "Y") %>% 
  nrow()

df2021 %>% 
  filter(rf_artec == "Y") %>% 
  nrow()

df2021 %>% 
  filter(rf_inftr == "Y", rf_fedrg == "N", rf_artec == "N") %>% 
  nrow()

rm(df2021)
```


```{r}
## wrangling data

# removing "na"
df <- df %>% 
  filter(meduc != 9, fagerec11 != 11, frace6 != 9, feduc != 9, apgar5 != 5, priorlive != 99)

# recoding mrace15 into mrace6 (properly)
df <- df %>%
  mutate(
    mrace6 = case_when(
      between(mrace15, 4, 10) ~ 4,
      between(mrace15, 11, 14) ~ 5,
      mrace15 == 15 ~ 6,
      TRUE ~ as.numeric(mrace15)
      ),
    Group = case_when(
      rf_inftr == "N" ~ "NT",
      TRUE ~ "T")
    )

df %>% dim()
```

# STAT DESC

<br>

Sur les `r df %>% nrow()` données de notre échantillon (2018 + 2019 + 2020 + 2021), on a:

<br>

```{r echo=FALSE}
df %>% 
  get_prop(rf_inftr) %>% 
  full_join(df %>% 
              get_prop(rf_fedrg),
            by = c("rf_inftr" = "rf_fedrg")) %>% 
  full_join(df %>% 
              get_prop(rf_artec),
            by = c("rf_inftr" = "rf_artec")) %>% 
  replace(is.na(.), 0) %>% 
  rename_all(function(x) c("Response", pma)) %>% 
  kableExtra::kbl() %>% 
  template()
```

<br>

```{r}
df %>%
  transform_age() %>% 
  pyrage(title="Age Pyramid (overall population)")
```

<br>

### Population cible

```{r}
pop <- df %>% filter(rf_fedrg == "Y")
pop %>% dim()

popnc <- df %>% filter(rf_fedrg != "Y")
popnc %>% dim()
```

<br>

Parmi ceux qui ont eu recours à des traitements contre l'infertilité, voici la répartition du recours ou non à des traitements contre l'infertilité sous forme de médicaments ou insémination artificielle ou sous forme d'assisted reproductive technology (ART) (IVF ou autres):
 :

<br>

```{r}
df %>% 
  filter(rf_inftr == "Y") %>% 
  get_prop(rf_fedrg) %>% 
  full_join(df %>% 
              filter(rf_inftr == "Y") %>% 
              get_prop(rf_artec),
            by = c("rf_fedrg" = "rf_artec")) %>% 
  replace(is.na(.), 0) %>% 
  rename_all(function(x) c("Response", pma[-1])) %>% 
  kableExtra::kbl() %>% 
  template()
```

<br>

**Répartition de la population cible selon le nombre d'enfants avant cette naissance:**

<br>

```{r}
pop %>% get_prop(priorlive) %>%
  kableExtra::kbl() %>% 
  template()
```

```{r}
popnc %>%
  get_prop(priorlive) %>%
  kableExtra::kbl() %>% 
  template()
```

### Age des parents

<br>

```{r}
pop %>%
  transform_age() %>% 
  pyrage(title="Age Pyramid (Treated)")
```

<br>

```{r}
popnc %>%
  transform_age() %>% 
  pyrage(title="Age Pyramid (Non-Treated)")
```

<br>

```{r}
fage <- data.frame(Age = c("< 15", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-98"), code = as.factor(c(1:10)))

fage %>% 
  mutate(`Father's age (years)` = Age, .keep = "unused") %>% 
  left_join(y = pop %>%
              get_prop(fagerec11) %>%
              data.frame(),
            by = c("code" = "fagerec11")
  ) %>% 
  mutate(`Treated` =   replace_na(Frequency, 0), .keep = "unused") %>% 
  left_join(y = popnc %>%
              get_prop(fagerec11) %>%
              data.frame() %>% 
              rename(`Non-Treated` = Frequency),
            by = c("code" = "fagerec11")) %>% 
  kableExtra::kbl() %>% 
  template()
```

<br>

```{r}
mage <- data.frame(Age = c("< 15", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54"), code = as.factor(c(1:9)))

mage %>% 
  mutate(`Mother's age (years)` = Age, .keep = "unused") %>% 
  left_join(y = pop %>%
              get_prop(mager9) %>%
              data.frame(),
            by = c("code" = "mager9")
  ) %>% 
  mutate(`Treated` =   replace_na(Frequency, 0), .keep = "unused") %>% 
  left_join(y = popnc %>%
              get_prop(mager9) %>%
              data.frame() %>% 
              rename(`Non-Treated` = Frequency),
            by = c("code" = "mager9")) %>% 
  kableExtra::kbl() %>% 
  template()
```

<br>

```{r}
pop %>% 
  transform_age() %>%
  summary("age")

popnc %>% 
  transform_age() %>%
  summary("age")
```

<br>

Sur la population cible, l'âge médian des hommes est de `r pop %>% transform_age() %>% filter(sex == "M") %>% summarize(res = median(age)) %>% pull(res)` ans, contre `r pop %>% transform_age() %>% filter(sex == "F") %>% summarize(res = median(age)) %>% pull(res)` ans pour les femmes.

Sur les non traités, l'âge médian des hommes est de `r popnc %>% transform_age() %>% filter(sex == "M") %>% summarize(res = median(age)) %>% pull(res)` ans, contre `r popnc %>% transform_age() %>% filter(sex == "F") %>% summarize(res = median(age)) %>% pull(res)` ans pour les femmes.

### Ethnie des parents

<br>

```{r}
recode_labels <- c(
  "1" = "White (only)",
  "2" = "Black (only)",
  "3" = "AIAN (only)",
  "4" = "Asian (only)",
  "5" = "NHOPI (only)",
  "6" = "More than one race"
  )
quick_title <- "father's race"

df %>%
  mutate(frace6 = recode(
    factor(frace6),
    !!!recode_labels
    )) %>% 
  plot_discrete_group(
    var=frace6,
    quick_title=quick_title,
    x="Race"
    ) +
  scale_x_discrete(guide = guide_axis(angle = 30))
```

<br>

```{r}
quick_title <- "mother's race"

df %>%
    mutate(mrace6 = recode(factor(mrace6), !!!recode_labels)) %>% 
  plot_discrete_group(
    var=mrace6,
    quick_title=quick_title,
    x="Race"
    ) +
  scale_x_discrete(guide = guide_axis(angle = 30))
```

<br>

### Education des parents

<br>

```{r}
recode_labels <- c(
  "1"="8th grade or less",
  "2"="9th through 12th grade with no diploma",
  "3"="High school graduate or GED completed",
  "4"="Some college credit, but not a degree",
  "5"="Associate degree (AA,AS)",
  "6"="Bachelor’s degree (BA, AB, BS)",
  "7"="Master’s degree (MA, MS, MEng, MEd, MSW, MBA)",
  "8"="Doctorate (PhD, EdD) or Professional Degree (MD, DDS, DVM, LLB, JD)"
  )
quick_title <- "mother's education"

df %>%
  mutate(meduc = recode(factor(meduc), !!!recode_labels)) %>% 
  plot_discrete_group(
    var=meduc,
    quick_title=quick_title,
    x="Education"
    ) +
  guides(fill = guide_legend(reverse=TRUE)) +
  coord_flip()
```

<br>

```{r}
quick_title <- "father's education"

df %>%
  mutate(feduc = recode(factor(feduc), !!!recode_labels)) %>% 
  plot_discrete_group(
    var=feduc,
    quick_title=quick_title,
    x="Education"
    ) +
  guides(fill = guide_legend(reverse=TRUE)) +
  coord_flip()
```

<br>

### Caractéristiques du couple

<br>

```{r}
df %>% 
  mutate(`Marital status` = recode(dmar, "1"="Married", "2"="Unmarried")) %>% 
  group_freq(`Marital status`, "Marital status")
```

<br>

```{r}
df %>%
  mutate(priorlive = case_when(
    as.numeric(priorlive) >= 4 ~ "4+",
    TRUE ~ as.character(priorlive)
    )) %>% 
  group_freq(priorlive, "Prior live")
```

<br>

QUESTION : doit-on recoder ainsi la variable "priorlive"? Sinon, va jusqu'à 20 mais avec des effectifs très faibles.

<br>

```{r}
df %>% grouped_summary(priorlive, "prior live")
```

<br>

```{r}
df %>% group_freq(dplural, "Twinning")
```

<br>

```{r}
df %>% grouped_summary(dplural, "twinning")
```

<br>

### Santé de l'enfant

<br>

```{r}
df %>% group_freq(apgar5r, "Score Apgar 5")
```

```{r}
df %>% filter(apgar5 != 99) %>% grouped_summary(apgar5, "Score Apgar 5")
```

<br>

```{r}
df %>% filter(dbwt != 9999) %>% grouped_summary(dbwt, "birth weight")
```


```{r}
df %>% 
  filter(rf_inftr == "Y" | rf_inftr == "N", apgar5 != 99) %>%
  
  # summarizing the variable to get the percentage by group
  
  group_by(rf_inftr, apgar5) %>%
  summarise(n = n()) %>%
  mutate(freq = n * 100 / sum(n)) %>% 
  
  # plot the 2 distributions (treated and NT) of the variable
  ggplot(mapping = aes(x = as.factor(apgar5), y = freq, fill = factor(rf_inftr))) +
  geom_bar(color = "grey30",
           alpha = 0.7,
           position = "dodge",
           stat = "identity") +
  scale_fill_discrete(name = "Group", labels = c("Non-Treated", "Treated")) +
  labs(title = glue::glue("Distribution of apgar score 5 by group"), x = "Score", y = "Frequency") + 
  theme_formatted()
```

<br>

```{r}
title <- glue::glue("Histogram chart of birthweight")
  
caption <- df %>% create_caption(var = "dbwt", nan = 9999)
  
df %>% 
  dplyr::filter(dbwt != 9999) %>% 
  ggplot2::ggplot(mapping = aes(x = dbwt, fill = rf_inftr)) +
  ggplot2::geom_density(color = "grey30", alpha = 0.6) +
  ggplot2::labs(title = title, x = "Birthweight", caption = caption) +
  scale_fill_discrete(name = "Group", labels = c("Non-Treated", "Treated")) +
  theme_formatted()
```

<br>

## Régressions linéaires

<br>

```{r}
to_keep <- c("dbwt", "mager", "meduc", "mrace6", "fagerec11", "feduc", "frace6", "priorlive", "dmar", "rf_artec")
df_reg <- df %>% select(to_keep)
```

<br>

Régression du poids à la naissance sur plusieurs variables explicatives (dont l'age de la mere au carré):

<br>

```{r}
df_reg$age2 <- df_reg$mager**2
df_reg$ldbwt <- df_reg$dbwt %>% log()

res <- lm(ldbwt ~ .,
       data = df_reg)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(res, type = "html")
```
</div>

<br>

En ajoutant l'année :

<br>

```{r}
df_reg <- df %>% select(to_keep, dob_yy)
df_reg$age2 <- df_reg$mager**2

res <- lm(dbwt ~ .,
       data = df_reg)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(res, type = "html")
```
</div>

<br>

En ajoutant la gémélité:

<br>

```{r}
df_reg <- df %>% select(to_keep, dplural)
MR3 <- lm(dbwt ~ .,
          data = df_reg)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(MR3, type = "html")
```
</div>

<br>

Avec la gémélité, l'année et l'age de la mere au carré:

<br>

```{r}
df_reg <- df %>% select(to_keep, dplural, dob_yy)

MR4 <- lm(dbwt ~ .,
          data = df_reg)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(MR4, type = "html")
```
</div>

<br>
### Corélation entre le recours à médicaments et la gémélité

```{r}
gemelite <- lm(dplural ~ mager + rf_fedrg + rf_artec, data=df)
```

<div align="center">
```{r, results='asis'}
stargazer::stargazer(gemelite, type = "html")
```
</div>

<br>

Reste à faire des tests d'indépendance (Khi2/KS/Student)