---
title: "matching exact"
output:
  pdf_document: default
  html_notebook: default
---

Le Notebook réalise des matchings exacts en se restreignant à différentes 
sous-populations. 

Matching exact = un croisement complet des covariables est utilisé pour former des sous-classes définies par chaque combinaison des niveaux de covariables. Toute sous-classe qui ne contient pas d'unités traitées et d'unités de contrôle est éliminée, ce qui ne laisse que des sous-classes contenant des unités traitées et des unités de contrôle qui sont exactement égales en ce qui concerne les covariables incluses. (source : help CRAN)

## Traitement des données

On charge les packages, les données et on les nettoie

```{r}
#setting environment
rm(list = ls())

library(data.table)
library(tidyverse)
library(tcltk)
library(lattice)

install.packages("devtools")
library(devtools)
install_github("https://github.com/IQSS/cem.git")

library(MatchIt)

install.packages("marginaleffects")
library(marginaleffects)

```
```{r}
#on définit la fonction load_data
load_data <- function(file, path = "data"){
  
  df <- arrow::read_csv_arrow(
    here::here(path, file)
  )
  return(df)
}
```


```{r}
#loading dataset
path <- "Data"
list.files(path = path)
file <- "data.csv"


to_keep <- c("dbwt", "mager", "meduc", "fagecomb", "feduc", "frace6", "mrace15",
             "rf_fedrg", "rf_artec", "priorlive", "dmar", "cig_rec", "mhisp_r", 
             "fhispx", "no_infec", "sex", "gestrec3", "dplural")

df <- load_data(file)%>%
  select(all_of(to_keep))
```

```{r}
# NETTOYAGE DES DONNEES

# pour mrace6, les labels sont mal codes, donc :
# recoding mrace15 into mrace6 (correctly)
df <- df %>%
  mutate(mrace6 = case_when(
    between(mrace15, 4, 10) ~ 4,
    between(mrace15, 11, 14) ~ 5,
    mrace15 == 15 ~ 6,
    TRUE ~ as.numeric(mrace15)
  )) %>% 
  select(!mrace15)

# on recode dmar
df <- df %>%
  mutate(dmar = case_when(
    dmar == 1 ~ 1,
    is.na(dmar) ~ 9,
    TRUE ~ 0))

# recoding rf_fedrg as follows :  X, U, N -> 0 & Y -> 1
df$rf_fedrg <- ifelse(df$rf_fedrg == "Y", 1, 0)

# recoding rf_artec as follows :  X, U, N -> 0 & Y -> 1
df$rf_artec <- ifelse(df$rf_artec == "Y", 1, 0)

#on supprime les valeurs unknown
df <- df %>% 
  filter(fagecomb != 99,
         meduc != 9,
         dbwt != 9999,
         feduc != 9,
         frace6 != 9,
         mrace6 != 9,
         priorlive != 99,
         mhisp_r != 9,
         fhispx != 9,
         cig_rec != "U",
         dmar != 9,
         no_infec != 9,
         gestrec3 != 3)

# recoding cigarette consumption from Y & N to 1 & 0 :
df %>% select(cig_rec) %>% distinct()
df$cig_rec <- ifelse(df$cig_rec == "Y", 1, 0)

#recoding sex
df$sex_M <-  ifelse(df$sex == "M" , 1, 0)
df <- df %>% select(!all_of(c("sex")))
```

##I. matching en distinguant les mères primipares ou non}

# 1. mères ayant déjà eu un enfant

```{r}
#### matching exact, mère primipares, trairement rf_fedrg ####
#on filtre la présence de naissances single
df1 <- df %>% filter(priorlive == 1) # 287816 observations

#on réalise le matching
m_1 <- matchit(rf_fedrg ~ mager + meduc + fagecomb + feduc + frace6 + mrace6 +
                dmar + cig_rec + mhisp_r + fhispx + no_infec + sex_M + gestrec3,
               data = df1,
               method = "exact",
               k2k = TRUE,
               estimand = "ATT")
summary(m_1) 

```

```{r}
#on plot les distributions
plot(m_1, type = "density", interactive = FALSE)

```
```{r}
plot(summary(m_1))
```


```{r}

#on cherche à représenter toutes les variables
md_1 <- match.data(m_1)
summary(md_1)
```

```{r}

#on affiche les traités
md_1_T <- match.data(m_1, group = "treated")
print(summary(md_1_T))
#à la main, moyenne dbwt pour les traités = 3289

```

```{r}
#on affiche les contrôles
md_1_C <- match.data(m_1, group="control")
print(summary(md_1_C))
#à la main, moyenne dbwt pour les contrôles = 3405

```

```{r}
#puis on estime l'ATT
fit_1 <- lm(dbwt ~ rf_fedrg * (mager + meduc + fagecomb + feduc + frace6 + mrace6 +
                               dmar + cig_rec + mhisp_r + fhispx + no_infec + sex_M 
                               + gestrec3), data = md_1)

avg_comparisons(fit_1, variables = "rf_fedrg", vcov = ~subclass,
                newdata = subset(md_1, rf_fedrg == 1))

#résultats : estimation à -88,3
#résultats à la main : 3289-3405 = -116
```




## Mères primipares

```{r}
#### matching exact, mères primipares, trairement rf_fedrg ####
#on filtre la présence de naissances single
df0 <- df %>% filter(priorlive == 0) # 287816 observations

#on réalise le matching
m_0 <- matchit(rf_fedrg ~ mager + meduc + fagecomb + feduc + frace6 + mrace6 +
                dmar + cig_rec + mhisp_r + fhispx + no_infec + sex_M + gestrec3,
               data = df0,
               method = "exact",
               k2k = TRUE,
               estimand = "ATT")
summary(m_0) 

```

```{r}
#on plot les distributions
plot(m_0, type = "density", interactive = FALSE)

```
```{r}
plot(summary(m_0))
```


```{r}

#on cherche à représenter toutes les variables
md_0 <- match.data(m_0)
summary(md_0)
```

```{r}

#on affiche les traités
md_0_T <- match.data(m_0, group = "treated")
summary(md_0_T)
#à la main, moyenne dbwt pour les contrôles = 

```

```{r}
#on affiche les contrôles
md_0_C <- match.data(m_0, group="control")
summary(md_0_C)
#à la main, moyenne dbwt pour les contrôles = 

```



## matching en distinguant les naissances de jumeaux et de non jumeaux

# matching avec les jumeaux

```{r}
#on filtre la présence de naissances plural
dfJ <- df %>% filter(dplural != 1) #on a 103146 observations

m_J <- matchit(rf_fedrg ~ + mager + meduc + fagecomb + feduc + frace6 + mrace6 +
               priorlive + dmar + cig_rec + mhisp_r + fhispx + no_infec + sex_M + gestrec3 + dplural,
             data = dfJ,
             method = "exact",
             k2k = TRUE,
             estimand = "ATT") 

summary(m_J) 

```

```{r}
#on plot les distributions
plot(m_J, type = "density", interactive = FALSE)
```

```{r}
plot(summary(m_J))
```

```{r}
#on cherche à représenter toutes les variables
md_J <- match.data(m_J)
summary(md_J)
```

```{r}
#on cherche des informations sur les traités
md_J_T <- match.data(m_J, group = "treated")
summary(md_J_T)
#à la main, moyenne dbwt pour les traités = 2440

```

```{r}
#on cherche des informations sur les contrôles
md_J_C <- match.data(m_J, group="control")
summary(md_J_C)
#à la main, moyenne dbwt pour les contrôles = 2470
```


```{r}
#puis on estime l'ATT
fit_J <- lm(dbwt ~ rf_fedrg * (mager + meduc + fagecomb + feduc + frace6 + mrace6 +
                                 priorlive + dmar + cig_rec + mhisp_r + fhispx + no_infec + sex_M 
                               + gestrec3), data = md_J)

avg_comparisons(fit_J, variables = "rf_fedrg", vcov = ~subclass,
                newdata = subset(md_J, rf_fedrg == 1))

# résultat : -14,1
# résultats en calculant à la main : 2440 - 2470 = -30

```


On essaye de séparer les mères les plus âgées des mères plus jeunes : comparaison du dernier et du premier quantile

On compare les mères plus jeunes :

```{r}
md_J_Y <- md_J %>% filter(mager <= 30) #on a 5196 observations
summary(md_J_Y)
#à la main, moyenne dbwt pour les jumeaux des mères plus jeunes = 2381
```

```{r}
md_J_Y_T <- md_J_T %>% filter(mager <= 30) #on a 2850 observations
summary(md_J_Y_T)
#à la main, moyenne dbwt pour les jumeaux des mères plus jeunes traitées = 2350
```

```{r}
md_J_Y_C <- md_J_C %>% filter(mager <= 30) #on a 2346 observations
summary(md_J_Y_C)
#à la main, moyenne dbwt pour les jumeaux des mères plus jeunes contrôles = 2420
```
Et pour les mères plus âgées 

```{r}
md_J_O <- md_J %>% filter(mager >= 35) #on a 4747 observations
summary(md_J_O)
#à la main, moyenne dbwt pour les jumeaux des mères plus âgées = 2523
```

```{r}
md_J_O_T <- md_J_T %>% filter(mager >= 35) #on a 2356 observations
summary(md_J_O_T)
#à la main, moyenne dbwt pour les jumeaux des mères plus âgées traitées = 2523
```


```{r}
md_J_O_C <- md_J_C %>% filter(mager >= 35) #on a 2391 observations
summary(md_J_O_C)
#à la main, moyenne dbwt pour les jumeaux des mères plus jeunes traitées = 2527
```

# matching avec les single

```{r}
#on filtre la présence de naissances single
dfS <- df %>% filter(dplural == 1) #on a 103146 observations

m_S <- matchit(rf_fedrg ~ mager + meduc + fagecomb + feduc + frace6 + mrace6 +
               priorlive + dmar + cig_rec + mhisp_r + fhispx + no_infec + sex_M + gestrec3 + dplural,
             data = dfS,
             method = "exact",
             k2k = TRUE,
             estimand = "ATT") 

summary(m_S) 
```


```{r}
#on plot les distributions
plot(m_S, type = "density", interactive = FALSE)
```

```{r}
#on cherche à représenter toutes les variables
md_S <- match.data(m_S)
summary(md_S)
```

```{r}
#on cherche des informations sur les traités
md_S_T <- match.data(m_S, group = "treated")
summary(md_S_T)
#à la main, moyenne dbwt pour les traités = 
```

```{r}
#on cherche des informations sur les contrôles
md_S_C <- match.data(m_S, group="control")
summary(md_S_C)
#à la main, moyenne dbwt pour les contrôles =
```

```{r}
#puis on estime l'ATT
fit_S <- lm(dbwt ~ rf_fedrg * (mager + meduc + fagecomb + feduc + frace6 + mrace6 +
                                 priorlive + dmar + cig_rec + mhisp_r + fhispx + no_infec + sex_M 
                               + gestrec3), data = md_S)

avg_comparisons(fit_S, variables = "rf_fedrg", vcov = ~subclass,
                newdata = subset(md_S, rf_fedrg == 1))

# résultat : -37,2
# résultats en calculant à la main :

```



On essaye de séparer les mères les plus âgées des mères plus jeunes : comparaison du dernier et du premier quantile

On compare les mères plus jeunes :

```{r}
md_S_Y <- md_S %>% filter(mager <= 30) #on a  observations
summary(md_S_Y)
#à la main, moyenne dbwt pour les jumeaux des mères plus jeunes = 
```

```{r}
md_S_Y_T <- md_S_T %>% filter(mager <= 29) #on a  observations
summary(md_S_Y_T)
#à la main, moyenne dbwt pour les jumeaux des mères plus jeunes traitées = 
```

```{r}
md_S_Y_C <- md_S_C %>% filter(mager <= 30) #on a  observations
summary(md_S_Y_C)
#à la main, moyenne dbwt pour les jumeaux des mères plus jeunes contrôles = 
```

Et pour les mères plus âgées 

```{r}
md_S_O <- md_S %>% filter(mager >= 35) #on a  observations
summary(md_S_O)
#à la main, moyenne dbwt pour les jumeaux des mères plus âgées = 
```

```{r}
md_S_O_T <- md_S_T %>% filter(mager >= 35) #on a  observations
summary(md_S_O_T)
#à la main, moyenne dbwt pour les jumeaux des mères plus âgées traitées = 
```

```{r}
md_S_O_C <- md_S_C %>% filter(mager >= 35) #on a  observations
summary(md_S_O_C)
#à la main, moyenne dbwt pour les jumeaux des mères plus jeunes traitées = 
```